(function(C,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],t):(C=typeof globalThis<"u"?globalThis:C||self,t(C.trame_color_opacity={},C.Vue))})(this,function(C,t){"use strict";function U(n){return n.length===0?!1:Array.isArray(n[0][1])}const $=t.defineComponent({__name:"NodeScaler",props:t.mergeModels({xRange:{},yRange:{},xLog:{type:Boolean},yLog:{type:Boolean},slotPropsNames:{}},{nodes:{required:!0},nodesModifiers:{}}),emits:["update:nodes"],setup(n){const e=n,o=t.useModel(n,"nodes"),a=t.computed(()=>{const r=e.xRange!=null,l=e.yRange!=null;let d=[...o.value];if(o.value.length==0||!r&&!l)return d;if(U(d)){if(r){let c=Math.abs(e.xRange[1]-e.xRange[0]);d=d.map(i=>[(i[0]-e.xRange[0])/c,i[1]])}}else{if(r){let c=Math.abs(e.xRange[1]-e.xRange[0]);d=d.map(i=>[(i[0]-e.xRange[0])/c,i[1]])}if(l){let c=Math.abs(e.yRange[1]-e.yRange[0]);d=d.map(i=>[i[0],(i[1]-e.yRange[0])/c])}}return d});function s(r){const l=e.xRange!=null,d=e.yRange!=null;let c=[...r];if(c.length==0||!l&&!d){o.value=c;return}if(U(c)){if(l){let i=Math.abs(e.xRange[1]-e.xRange[0]);c=c.map(u=>[e.xRange[0]+u[0]*i,u[1]])}}else{if(l){let i=Math.abs(e.xRange[1]-e.xRange[0]);c=c.map(u=>[e.xRange[0]+u[0]*i,u[1]])}if(d){let i=Math.abs(e.yRange[1]-e.yRange[0]);c=c.map(u=>[u[0],e.yRange[0]+u[1]*i])}}o.value=c}return(r,l)=>t.renderSlot(r.$slots,"default",t.normalizeProps({[r.slotPropsNames.scaledNodes||""]:a.value,[`${r.slotPropsNames.scaledNodes}Updated`||""]:s}))}}),Q={ref:"div-root"},B=t.defineComponent({__name:"ViewportContainer",setup(n){const e=t.useTemplateRef("div-root"),o=t.ref([1,1]);let a=null;return t.onMounted(()=>{a=new ResizeObserver(()=>{if(e.value){const s=[e.value.clientWidth,e.value.clientHeight];(s[0]!=o.value[0]||s[1]!=o.value[1])&&setTimeout(()=>{o.value=s},0)}}),e.value&&a.observe(e.value)}),t.onBeforeUnmount(()=>{a&&a.disconnect()}),(s,r)=>(t.openBlock(),t.createElementBlock("div",Q,[t.renderSlot(s.$slots,"default",{viewportSize:o.value})],512))}}),b=t.defineComponent({__name:"BackgroundShaperFull",setup(n){return(e,o)=>t.renderSlot(e.$slots,"default",{shape:[[0,0],[1,0],[1,1],[0,1]]})}}),L=t.defineComponent({__name:"BackgroundShaperOpacity",props:{nodes:{}},setup(n){const e=n,o=t.computed(()=>{const a=e.nodes.length==0;let s=0,r=0;return a||(s=e.nodes[0][1],r=e.nodes[e.nodes.length-1][1]),[[0,0],[0,s],...e.nodes,[1,r],[1,0]]});return(a,s)=>t.renderSlot(a.$slots,"default",{shape:o.value})}}),S=t.defineComponent({__name:"BackgroundShaperHistograms",props:{nodes:{}},setup(n){const e=n,o=t.computed(()=>{const a=[],s=e.nodes.length==0;let r=0,l=1;s||(r=e.nodes[0][0],l=e.nodes[e.nodes.length-1][0]),a.push([0,0]),a.push([r,0]);for(let d=0;d<e.nodes.length-1;d++){const c=e.nodes[d][0],i=e.nodes[d][1],u=e.nodes[d+1][0];a.push([c,i]),a.push([u,i])}return a.push([l,0]),a.push([1,0]),a});return(a,s)=>t.renderSlot(a.$slots,"default",{shape:o.value})}}),W=t.defineComponent({__name:"BackgroundShaper",props:{backgroundShape:{},opacityNodes:{},histograms:{}},setup(n){return(e,o)=>e.opacityNodes&&e.backgroundShape==="opacity"?(t.openBlock(),t.createBlock(L,{key:0,nodes:e.opacityNodes},{default:t.withCtx(({shape:a})=>[t.renderSlot(e.$slots,"default",{shape:a})]),_:3},8,["nodes"])):e.histograms&&e.backgroundShape==="histograms"?(t.openBlock(),t.createBlock(S,{key:1,nodes:e.histograms},{default:t.withCtx(({shape:a})=>[t.renderSlot(e.$slots,"default",{shape:a})]),_:3},8,["nodes"])):(t.openBlock(),t.createBlock(b,{key:2},{default:t.withCtx(({shape:a})=>[t.renderSlot(e.$slots,"default",{shape:a})]),_:3}))}});function P(n,e,o,a){if(a<=o)return o;const s=Math.floor(o+(a-o)/2),r=e-n[s].value,l=e-n[s+1].value;return r<0?P(n,e,o,s-1):l<0?s:P(n,e,s+1,a)}const Z=(n,e,o)=>{const a=(n-e)/(o-e);return[1-a,a]};function ee(n){return n.value!==void 0&&n.mapped!==void 0}function A(n){return n.length>0&&ee(n[0])}function I(n,e,o,a){return n*e+o*a}function D(n,e,o,a){return[n*e[0]+o*a[0],n*e[1]+o*a[1],n*e[2]+o*a[2]]}function v(n){return n||Z}function x(n,e,o){return!Array.isArray(n)||n.length<1?ne:A(n)?F(n,e,v(o),D):H(n,e,v(o),D)}function oe(n,e,o){return!Array.isArray(n)||n.length<1?te:A(n)?F(n,e,v(o),I):H(n,e,v(o),I)}function F(n,e,o,a){const s=n.sort((r,l)=>r.value<l.value?-1:1);return function(r){const l=e(r),d=P(s,l,0,s.length-1);if(d==0&&l<s[0].value)return s[d].mapped;if(d==s.length-1)return s[d].mapped;const[c,i]=o(l,s[d].value,s[d+1].value);return a(c,s[d].mapped,i,s[d+1].mapped)}}function H(n,e,o,a){return function(s){const r=e(s),l=(n.length-1)*r;if(l<=0)return n[0];if(l>=n.length-1)return n[n.length-1];const d=Math.floor(l),[c,i]=o(l,d,d+1);return a(c,n[d],i,n[d+1])}}function ne(n){return[0,0,0]}function te(n){return 1}function X(n,e){let[o,a]=n;const[s,r]=e;return Math.abs(o-a)<Number.EPSILON&&(a=o+1),function(l){return s+(r-s)*((l-o)/(a-o))}}function w(n,e,o,a){return[o[0]+n[0]*a[0],e[1]-o[1]-n[1]*a[1]]}function V(n,e,o,a){return[(n[0]-o[0])/a[0],(e[1]-o[1]-n[1])/a[1]]}function z(n,e){return[n[0]-e.left,n[1]-e.top]}function q(n,e){let o=e.getImageData(n[0],n[1],1,1).data;return o[3]===255?{id:o[1],type:o[0]==0?"handle":"edge"}:null}function ae(n,e,o){return n==0?[0,e[1][0]-o,0,1]:n==e.length-1?[e[n-1][0]+o,1,0,1]:[e[n-1][0]+o,e[n+1][0]-o,0,1]}function se(n,e){const o=[...n];return o[0]<e[0]&&(o[0]=e[0]),o[0]>e[1]&&(o[0]=e[1]),o[1]<e[2]&&(o[1]=e[2]),o[1]>e[3]&&(o[1]=e[3]),o}function Y(n,e,o,a,s,r){if(n.clearRect(0,0,e[0],e[1]),s.length<2)return;let l=w([0,0],e,o,a),d=w([1,0],e,o,a),c=n.createLinearGradient(l[0],l[1],d[0],d[1]);r.forEach(i=>{const[u,p]=i;let[h,f,N,m]=p;p.length<4&&(m=1),c.addColorStop(u,`rgba(${h*255}, ${f*255}, ${N*255}, ${m})`)}),n.fillStyle=c,n.beginPath(),l=w(s[0],e,o,a),n.moveTo(l[0],l[1]);for(let i=1;i<s.length;i++)l=w(s[i],e,o,a),n.lineTo(l[0],l[1]);n.fill()}function j(n,e,o,a,s,r,l,d,c,i,u){if(n.clearRect(0,0,o[0],o[1]),e.clearRect(0,0,o[0],o[1]),d&&r.length>1){n.beginPath(),e.lineWidth=l*3,e.beginPath();let[p,h]=w(r[0],o,a,s);n.moveTo(p,h),e.moveTo(p,h);for(let f=1;f<r.length;++f){let[N,m]=w(r[f],o,a,s);e.strokeStyle=`rgb(1, ${f-1}, 0)`,n.lineTo(N,m),e.lineTo(N,m),e.stroke(),e.beginPath(),e.moveTo(N,m)}n.strokeStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${u[3]})`,n.lineWidth=c*1+1,n.stroke(),n.strokeStyle=`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${i[3]})`,n.lineWidth=c,n.stroke()}n.fillStyle=`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${i[3]})`,n.strokeStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${u[3]})`,n.lineWidth=2;for(let p=0;p<r.length;++p){let[h,f]=w(r[p],o,a,s);n.beginPath(),n.arc(h,f,l,0,2*Math.PI),n.fill(),n.stroke(),e.fillStyle=`rgb(0, ${p}, ${p})`,e.beginPath(),e.arc(h,f,l*3,0,2*Math.PI),e.fill()}}const re={class:"trame-colormap-background",ref:"background-canvas"},le=t.defineComponent({__name:"BackgroundView",props:{nodes:{},shape:{},size:{},padding:{}},setup(n){const e=n,o=t.useTemplateRef("background-canvas"),a=t.computed(()=>[Math.max(e.size[0]-2*e.padding[0],0),Math.max(e.size[1]-2*e.padding[1],0)]);return t.watch(()=>[o,e.size,e.padding,e.shape,e.nodes],()=>{if(!o.value)return;const s=o.value.getContext("2d");s&&(o.value.width=e.size[0],o.value.height=e.size[1],Y(s,e.size,e.padding,a.value,e.shape,e.nodes))}),t.onMounted(()=>{if(!o.value)return;const s=o.value.getContext("2d");s&&(o.value.width=e.size[0],o.value.height=e.size[1],Y(s,e.size,e.padding,a.value,e.shape,e.nodes))}),(s,r)=>(t.openBlock(),t.createElementBlock("canvas",re,null,512))}}),O=(n,e)=>{const o=n.__vccOpts||n;for(const[a,s]of e)o[a]=s;return o},R=O(le,[["__scopeId","data-v-90a91d27"]]),de={class:"fill"},ie={class:"fill controls-canvas picking-canvas",ref:"pick-canvas"},T=O(t.defineComponent({__name:"ControlsView",props:{nodes:{},color:{default:()=>[.125,.125,.125,1]},borderColor:{default:()=>[.75,.75,.75,1]},size:{},padding:{default:()=>[7,7]},radius:{default:7},showLine:{type:Boolean,default:!0},lineWidth:{default:3}},emits:["update:nodes"],setup(n,{emit:e}){const o=n,a=e,s=t.useTemplateRef("controls-canvas"),r=t.useTemplateRef("pick-canvas"),l=t.ref(-1),d=t.computed(()=>[Math.max(o.size[0]-2*o.padding[0],0),Math.max(o.size[1]-2*o.padding[1],0)]),c=t.computed(()=>[o.color[0]*255,o.color[1]*255,o.color[2]*255,o.color[3]]),i=t.computed(()=>[o.borderColor[0]*255,o.borderColor[1]*255,o.borderColor[2]*255,o.borderColor[3]]);t.watch(()=>[s,r,o.size,o.padding,o.nodes,o.radius,o.showLine,o.lineWidth,c,i],()=>{if(!s.value||!r.value)return;const m=s.value.getContext("2d"),g=r.value.getContext("2d");!m||!g||(s.value.width=o.size[0],s.value.height=o.size[1],r.value.width=o.size[0],r.value.height=o.size[1],j(m,g,o.size,o.padding,d.value,o.nodes,o.radius,o.showLine,o.lineWidth,c.value,i.value))}),t.onMounted(()=>{if(!s.value||!r.value)return;const m=s.value.getContext("2d"),g=r.value.getContext("2d");!m||!g||(s.value.width=o.size[0],s.value.height=o.size[1],r.value.width=o.size[0],r.value.height=o.size[1],j(m,g,o.size,o.padding,d.value,o.nodes,o.radius,o.showLine,o.lineWidth,c.value,i.value))});function u(m){if(l.value<0||!s.value)return;const g=z([m.clientX,m.clientY],s.value.getBoundingClientRect());let y=V(g,o.size,o.padding,d.value);const M=ae(l.value,o.nodes,.001);y=se(y,M);const k=o.nodes[l.value];if(y[0]==k[0]&&y[1]==k[1])return;const _=[...o.nodes];_[l.value]=y,a("update:nodes",_)}function p(m,g){if(g){if(g.type==="handle")l.value=g.id;else{let y=V(m,o.size,o.padding,d.value);l.value=g.id+1,a("update:nodes",[...o.nodes.slice(0,g.id+1),y,...o.nodes.slice(g.id+1,o.nodes.length)])}window.addEventListener("mousemove",u),window.addEventListener("mouseup",()=>{l.value=-1,window.removeEventListener("mousemove",u)})}else l.value=-1}function h(m,g){g&&g.type==="handle"&&a("update:nodes",[...o.nodes.slice(0,g.id),...o.nodes.slice(g.id+1,o.nodes.length)])}function f(m){if(!s.value||!r.value)return;const g=z([m.clientX,m.clientY],s.value.getBoundingClientRect());if(q(g,r.value.getContext("2d")))return;let M=V(g,o.size,o.padding,d.value),k=-1;for(let _=0;_<o.nodes.length&&!(o.nodes[_][0]>M[0]);_++)k=_;a("update:nodes",[...o.nodes.slice(0,k+1),M,...o.nodes.slice(k+1,o.nodes.length)])}function N(m){if(!s.value||!r.value)return;const g=z([m.clientX,m.clientY],s.value.getBoundingClientRect()),y=q(g,r.value.getContext("2d"));m.button==0?p(g,y):m.button==1||h(g,y)}return(m,g)=>(t.openBlock(),t.createElementBlock("div",de,[t.createElementVNode("canvas",ie,null,512),t.createElementVNode("canvas",{onDblclick:f,onMousedown:N,onContextmenu:g[0]||(g[0]=y=>y.preventDefault()),class:"fill controls-canvas",ref:"controls-canvas"},null,544)]))}}),[["__scopeId","data-v-fe9c8e77"]]);class E{_node;constructor(e){this._node=e}get value(){return this._node[0]}get mapped(){return this._node[1]}}const G=t.defineComponent({__name:"NodeMerger",props:{colorNodes:{},opacityNodes:{}},setup(n){const e=n,o=t.computed(()=>e.colorNodes.map(r=>new E(r))),a=t.computed(()=>e.opacityNodes.map(r=>new E(r))),s=t.computed(()=>{const r=X([0,1],[0,1]),l=x(o.value,r),d=oe(a.value,r),c=[];let i=0,u=0;for(;i<o.value.length&&u<a.value.length;){let p=1/0,h=1/0,f=0;i<o.value.length&&(p=o.value[i].value),u<a.value.length&&(h=a.value[u].value),p==h?(f=p,i++,u++):p<h?(f=p,i++):(f=h,u++);let N=[...l(f),d(f)];c.push([f,N])}return c});return(r,l)=>t.renderSlot(r.$slots,"default",{colorOpacityNodes:s.value})}}),J=t.defineComponent({__name:"NodeFlattener",props:t.mergeModels({nodes:{},slotPropsNames:{}},{nodes:{required:!0},nodesModifiers:{}}),emits:["update:nodes"],setup(n){const e=n,o=t.useModel(n,"nodes"),a=t.computed(()=>e.nodes.map(r=>[r[0],.5]));function s(r){const l=[...e.nodes];if(l.length==r.length){const d=r.map((c,i)=>[c[0],l[i][1]]);o.value=d}else{const d=l.map(f=>new E(f)),c=X([0,1],[0,1]),i=x(d,c),u=1e-4;let p=0;const h=[];for(let f=0;f<r.length;f++)Math.abs(l[p][0]-r[f][0])<u?(h.push([r[f][0],l[p][1]]),p++):h.push([r[f][0],i(r[f][0])]);o.value=h}}return(r,l)=>t.renderSlot(r.$slots,"default",t.normalizeProps({[r.slotPropsNames.flattenedNodes||""]:a.value,[`${r.slotPropsNames.flattenedNodes}Updated`||""]:s}))}}),K={trameCoeColorOpacityEditor:O(t.defineComponent({__name:"ColorOpacityEditor",props:t.mergeModels({scalarRange:{},histogramsRange:{},backgroundShape:{default:"opacity"},backgroundOpacity:{type:Boolean},histograms:{},showHistograms:{type:Boolean,default:!1},style:{},viewportPadding:{default:()=>[8,8]},histogramsColor:{default:()=>[0,0,0,.25]},handleColor:{default:()=>[.125,.125,.125,1]},handleBorderColor:{default:()=>[.75,.75,.75,1]},handleRadius:{default:7},lineWidth:{default:2}},{colorNodes:{required:!0},colorNodesModifiers:{},opacityNodes:{required:!0},opacityNodesModifiers:{}}),emits:["update:colorNodes","update:opacityNodes"],setup(n){const e=t.useModel(n,"colorNodes"),o=t.useModel(n,"opacityNodes");return(a,s)=>(t.openBlock(),t.createElementBlock("div",{class:"color-opacity-editor-root-container",style:t.normalizeStyle(a.style)},[t.createVNode($,{nodes:a.histograms,"onUpdate:nodes":s[2]||(s[2]=r=>a.histograms=r),xRange:a.scalarRange,yRange:a.histogramsRange,slotPropsNames:{scaledNodes:"scaledHistograms"}},{default:t.withCtx(({scaledHistograms:r,scaledHistogramsUpdated:l})=>[t.createVNode($,{nodes:e.value,"onUpdate:nodes":s[1]||(s[1]=d=>e.value=d),xRange:a.scalarRange,slotPropsNames:{scaledNodes:"scaledColorNodes"}},{default:t.withCtx(({scaledColorNodes:d,scaledColorNodesUpdated:c})=>[t.createVNode($,{nodes:o.value,"onUpdate:nodes":s[0]||(s[0]=i=>o.value=i),xRange:a.scalarRange,slotPropsNames:{scaledNodes:"scaledOpacityNodes"}},{default:t.withCtx(({scaledOpacityNodes:i,scaledOpacityNodesUpdated:u})=>[t.createVNode(B,{class:"color-opacity-editor-opacity-container"},{default:t.withCtx(({viewportSize:p})=>[t.createVNode(W,{backgroundShape:a.backgroundShape,opacityNodes:i,histograms:r},{default:t.withCtx(({shape:h})=>[a.backgroundOpacity?(t.openBlock(),t.createBlock(G,{key:0,colorNodes:d,opacityNodes:i},{default:t.withCtx(({colorOpacityNodes:f})=>[t.createVNode(R,{shape:h,size:p,padding:a.viewportPadding,nodes:f},null,8,["shape","size","padding","nodes"])]),_:2},1032,["colorNodes","opacityNodes"])):(t.openBlock(),t.createBlock(R,{key:1,shape:h,size:p,padding:a.viewportPadding,nodes:d},null,8,["shape","size","padding","nodes"]))]),_:2},1032,["backgroundShape","opacityNodes","histograms"]),a.showHistograms?(t.openBlock(),t.createBlock(S,{key:0,nodes:r},{default:t.withCtx(({shape:h})=>[t.createVNode(R,{shape:h,size:p,padding:a.viewportPadding,nodes:[[0,a.histogramsColor]],class:"color-opacity-editor-canvas"},null,8,["shape","size","padding","nodes"])]),_:2},1032,["nodes"])):t.createCommentVNode("",!0),t.createVNode(T,{size:p,padding:a.viewportPadding,showLine:"",radius:a.handleRadius,lineWidth:a.lineWidth,color:a.handleColor,borderColor:a.handleBorderColor,nodes:i,"onUpdate:nodes":u},null,8,["size","padding","radius","lineWidth","color","borderColor","nodes","onUpdate:nodes"])]),_:2},1024),t.createVNode(B,{class:"color-opacity-editor-color-container"},{default:t.withCtx(({viewportSize:p})=>[t.createVNode(b,null,{default:t.withCtx(({shape:h})=>[t.createVNode(R,{shape:h,size:p,padding:a.viewportPadding,nodes:d},null,8,["shape","size","padding","nodes"])]),_:2},1024),t.createVNode(J,{nodes:d,"onUpdate:nodes":c,slotPropsNames:{flattenedNodes:"flattenedColorNodes"}},{default:t.withCtx(({flattenedColorNodes:h,flattenedColorNodesUpdated:f})=>[t.createVNode(T,{size:p,padding:[a.viewportPadding[0],0],radius:a.handleRadius,color:a.handleColor,borderColor:a.handleBorderColor,showLine:!1,nodes:h,"onUpdate:nodes":f},null,8,["size","padding","radius","color","borderColor","nodes","onUpdate:nodes"])]),_:2},1032,["nodes","onUpdate:nodes"])]),_:2},1024)]),_:2},1032,["nodes","xRange"])]),_:2},1032,["nodes","xRange"])]),_:1},8,["nodes","xRange","yRange"])],4))}}),[["__scopeId","data-v-30569cac"]]),trameCoeNodeScaler:$,trameCoeNodeMerger:G,trameCoeNodeFlattener:J,trameCoeViewportContainer:B,trameCoeBackgroundShaper:W,trameCoeBackgroundShaperFull:b,trameCoeBackgroundShaperOpacity:L,trameCoeBackgroundShaperHistograms:S,trameCoeBackgroundView:R,trameCoeControlsView:T};function ce(n){Object.keys(K).forEach(e=>{n.component(e,K[e])})}C.install=ce,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_color_opacity.umd.js.map
